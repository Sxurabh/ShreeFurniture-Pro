# 05 — Database Schema
## Shree Furniture | E-Commerce Platform

> **Version:** 1.0 | **Engine:** PostgreSQL 16 | **ORM:** MikroORM (via MedusaJS v2)

---

## 1. Overview

PostgreSQL 16 is the single source of truth for all commerce data. All schemas below are managed by MedusaJS v2 — the platform uses MedusaJS's built-in entity definitions with custom extensions for furniture-specific fields (room type, assembly required, etc.).

**Conventions:**
- All IDs are prefixed strings (`prod_`, `var_`, `ord_`, `cus_`, etc.) generated by MedusaJS
- `created_at` and `updated_at` timestamps on every table (managed by MikroORM)
- Soft deletes via `deleted_at` nullable timestamp — records are never hard-deleted
- Monetary values stored as integers in paise (₹1 = 100 paise) to avoid floating-point errors
- All slugs/handles are lowercase, hyphenated strings

---

## 2. Core Schema Domains

### 2.1 Product Catalogue

```sql
-- Primary product entity
product (
  id                  VARCHAR(255) PRIMARY KEY,   -- e.g., prod_01ABCDEF
  title               VARCHAR(255) NOT NULL,
  handle              VARCHAR(255) UNIQUE NOT NULL, -- URL slug: oslo-3-seater-sofa
  description         TEXT,
  subtitle            VARCHAR(255),
  thumbnail           VARCHAR(1000),              -- Cloudinary CDN URL
  status              ENUM('draft','published','proposed','rejected') DEFAULT 'draft',
  is_giftcard         BOOLEAN DEFAULT false,
  discountable        BOOLEAN DEFAULT true,
  -- Custom furniture fields:
  room_type           VARCHAR(100),               -- living-room, bedroom, dining, office
  assembly_required   BOOLEAN DEFAULT false,
  weight_kg           DECIMAL(6,2),
  metadata            JSONB,                      -- flexible key-value extensions
  collection_id       VARCHAR(255) REFERENCES product_collection(id),
  created_at          TIMESTAMPTZ DEFAULT NOW(),
  updated_at          TIMESTAMPTZ DEFAULT NOW(),
  deleted_at          TIMESTAMPTZ
)

-- Room-based collections (Living Room, Bedroom, Dining, Office)
product_collection (
  id                  VARCHAR(255) PRIMARY KEY,   -- pcol_01ABCDEF
  title               VARCHAR(255) NOT NULL,
  handle              VARCHAR(255) UNIQUE NOT NULL,
  metadata            JSONB,
  created_at          TIMESTAMPTZ DEFAULT NOW(),
  updated_at          TIMESTAMPTZ DEFAULT NOW(),
  deleted_at          TIMESTAMPTZ
)

-- Option types per product (Colour, Size, Material)
product_option (
  id                  VARCHAR(255) PRIMARY KEY,
  title               VARCHAR(255) NOT NULL,      -- "Colour", "Size"
  product_id          VARCHAR(255) REFERENCES product(id),
  created_at          TIMESTAMPTZ DEFAULT NOW(),
  updated_at          TIMESTAMPTZ DEFAULT NOW()
)

-- Option values (Grey, Walnut, L, XL)
product_option_value (
  id                  VARCHAR(255) PRIMARY KEY,
  value               VARCHAR(255) NOT NULL,      -- "Grey", "Walnut Brown"
  option_id           VARCHAR(255) REFERENCES product_option(id),
  variant_id          VARCHAR(255) REFERENCES product_variant(id),
  created_at          TIMESTAMPTZ DEFAULT NOW(),
  updated_at          TIMESTAMPTZ DEFAULT NOW()
)

-- SKU-level entity: each colour/size combination
product_variant (
  id                  VARCHAR(255) PRIMARY KEY,   -- variant_01ABCDEF
  product_id          VARCHAR(255) REFERENCES product(id),
  title               VARCHAR(255) NOT NULL,      -- "Grey / L"
  sku                 VARCHAR(255) UNIQUE,        -- SF-SOFA-OSLO-GRY-L
  barcode             VARCHAR(255),
  ean                 VARCHAR(255),
  inventory_quantity  INTEGER DEFAULT 0,
  allow_backorder     BOOLEAN DEFAULT false,
  manage_inventory    BOOLEAN DEFAULT true,
  weight              INTEGER,                    -- grams
  length              INTEGER,                    -- mm
  height              INTEGER,                    -- mm
  width               INTEGER,                    -- mm
  metadata            JSONB,
  created_at          TIMESTAMPTZ DEFAULT NOW(),
  updated_at          TIMESTAMPTZ DEFAULT NOW(),
  deleted_at          TIMESTAMPTZ
)

-- Product images (multiple per product, ordered)
product_image (
  id                  VARCHAR(255) PRIMARY KEY,
  product_id          VARCHAR(255) REFERENCES product(id),
  url                 VARCHAR(1000) NOT NULL,     -- Cloudinary CDN URL
  rank                INTEGER DEFAULT 0,          -- display order
  created_at          TIMESTAMPTZ DEFAULT NOW(),
  updated_at          TIMESTAMPTZ DEFAULT NOW()
)

-- Product tags for search and filtering
product_tag (
  id                  VARCHAR(255) PRIMARY KEY,
  value               VARCHAR(255) NOT NULL,      -- "wood", "scandinavian", "compact"
  created_at          TIMESTAMPTZ DEFAULT NOW(),
  updated_at          TIMESTAMPTZ DEFAULT NOW()
)

product_tags (  -- join table
  product_id          VARCHAR(255) REFERENCES product(id),
  product_tag_id      VARCHAR(255) REFERENCES product_tag(id),
  PRIMARY KEY (product_id, product_tag_id)
)
```

### 2.2 Pricing

```sql
-- Price lists (e.g., regular, sale)
price_list (
  id                  VARCHAR(255) PRIMARY KEY,
  name                VARCHAR(255) NOT NULL,
  description         TEXT,
  type                ENUM('sale','override') NOT NULL,
  status              ENUM('active','draft'),
  starts_at           TIMESTAMPTZ,
  ends_at             TIMESTAMPTZ,
  created_at          TIMESTAMPTZ DEFAULT NOW(),
  updated_at          TIMESTAMPTZ DEFAULT NOW()
)

-- Money amounts per variant per region/currency
money_amount (
  id                  VARCHAR(255) PRIMARY KEY,
  variant_id          VARCHAR(255) REFERENCES product_variant(id),
  currency_code       VARCHAR(3) DEFAULT 'inr',
  amount              INTEGER NOT NULL,           -- in paise (₹100 = 10000)
  min_quantity        INTEGER,
  max_quantity        INTEGER,
  price_list_id       VARCHAR(255) REFERENCES price_list(id),
  region_id           VARCHAR(255),
  created_at          TIMESTAMPTZ DEFAULT NOW(),
  updated_at          TIMESTAMPTZ DEFAULT NOW()
)
```

### 2.3 Cart

```sql
cart (
  id                  VARCHAR(255) PRIMARY KEY,   -- cart_01ABCDEF
  email               VARCHAR(255),
  type                ENUM('default','swap','draft_order','payment_link','claim') DEFAULT 'default',
  customer_id         VARCHAR(255) REFERENCES customer(id),
  billing_address_id  VARCHAR(255) REFERENCES address(id),
  shipping_address_id VARCHAR(255) REFERENCES address(id),
  region_id           VARCHAR(255),
  discount_total      INTEGER DEFAULT 0,
  shipping_total      INTEGER DEFAULT 0,
  subtotal            INTEGER DEFAULT 0,
  tax_total           INTEGER DEFAULT 0,
  total               INTEGER DEFAULT 0,
  completed_at        TIMESTAMPTZ,
  payment_authorized_at TIMESTAMPTZ,
  metadata            JSONB,
  created_at          TIMESTAMPTZ DEFAULT NOW(),
  updated_at          TIMESTAMPTZ DEFAULT NOW(),
  deleted_at          TIMESTAMPTZ
)

line_item (
  id                  VARCHAR(255) PRIMARY KEY,
  cart_id             VARCHAR(255) REFERENCES cart(id),
  order_id            VARCHAR(255) REFERENCES "order"(id),
  title               VARCHAR(255) NOT NULL,      -- Snapshot: product name at time of add
  description         TEXT,
  thumbnail           VARCHAR(1000),              -- Snapshot: image URL
  variant_id          VARCHAR(255) REFERENCES product_variant(id),
  quantity            INTEGER NOT NULL,
  unit_price          INTEGER NOT NULL,           -- paise, snapshot at time of add
  subtotal            INTEGER,
  tax_total           INTEGER,
  total               INTEGER,
  metadata            JSONB,
  created_at          TIMESTAMPTZ DEFAULT NOW(),
  updated_at          TIMESTAMPTZ DEFAULT NOW()
)
```

### 2.4 Orders & Fulfilment

```sql
"order" (
  id                  VARCHAR(255) PRIMARY KEY,   -- ord_01ABCDEF
  status              ENUM('pending','completed','archived','canceled','requires_action') DEFAULT 'pending',
  fulfillment_status  ENUM('not_fulfilled','partially_fulfilled','fulfilled','partially_shipped','shipped','partially_returned','returned','canceled','requires_action') DEFAULT 'not_fulfilled',
  payment_status      ENUM('not_paid','awaiting','captured','partially_refunded','refunded','canceled','requires_action') DEFAULT 'not_paid',
  display_id          SERIAL,                     -- human-readable order number
  cart_id             VARCHAR(255) REFERENCES cart(id),
  customer_id         VARCHAR(255) REFERENCES customer(id),
  email               VARCHAR(255) NOT NULL,
  billing_address_id  VARCHAR(255) REFERENCES address(id),
  shipping_address_id VARCHAR(255) REFERENCES address(id),
  region_id           VARCHAR(255),
  currency_code       VARCHAR(3) DEFAULT 'inr',
  subtotal            INTEGER DEFAULT 0,
  shipping_total      INTEGER DEFAULT 0,
  discount_total      INTEGER DEFAULT 0,
  tax_total           INTEGER DEFAULT 0,
  total               INTEGER NOT NULL,
  refunded_total      INTEGER DEFAULT 0,
  metadata            JSONB,
  created_at          TIMESTAMPTZ DEFAULT NOW(),
  updated_at          TIMESTAMPTZ DEFAULT NOW()
)

fulfillment (
  id                  VARCHAR(255) PRIMARY KEY,
  order_id            VARCHAR(255) REFERENCES "order"(id),
  provider_id         VARCHAR(255),               -- shipping provider
  tracking_numbers    TEXT[],                     -- array of tracking numbers
  tracking_links      JSONB,
  shipped_at          TIMESTAMPTZ,
  canceled_at         TIMESTAMPTZ,
  data                JSONB,
  metadata            JSONB,
  created_at          TIMESTAMPTZ DEFAULT NOW(),
  updated_at          TIMESTAMPTZ DEFAULT NOW()
)

-- Payment records linked to Razorpay
payment (
  id                  VARCHAR(255) PRIMARY KEY,
  cart_id             VARCHAR(255),
  order_id            VARCHAR(255) REFERENCES "order"(id),
  amount              INTEGER NOT NULL,
  currency_code       VARCHAR(3) DEFAULT 'inr',
  amount_refunded     INTEGER DEFAULT 0,
  provider_id         VARCHAR(255),               -- 'razorpay'
  data                JSONB,                      -- razorpay_order_id, payment_id, signature
  captured_at         TIMESTAMPTZ,
  canceled_at         TIMESTAMPTZ,
  created_at          TIMESTAMPTZ DEFAULT NOW(),
  updated_at          TIMESTAMPTZ DEFAULT NOW()
)
```

### 2.5 Customers

```sql
customer (
  id                  VARCHAR(255) PRIMARY KEY,   -- cus_01ABCDEF
  email               VARCHAR(255) UNIQUE NOT NULL,
  first_name          VARCHAR(255),
  last_name           VARCHAR(255),
  billing_address_id  VARCHAR(255),
  phone               VARCHAR(20),
  has_account         BOOLEAN DEFAULT false,
  password_hash       VARCHAR(255),
  metadata            JSONB,
  created_at          TIMESTAMPTZ DEFAULT NOW(),
  updated_at          TIMESTAMPTZ DEFAULT NOW(),
  deleted_at          TIMESTAMPTZ
)

address (
  id                  VARCHAR(255) PRIMARY KEY,
  customer_id         VARCHAR(255) REFERENCES customer(id),
  first_name          VARCHAR(255),
  last_name           VARCHAR(255),
  company             VARCHAR(255),
  address_1           VARCHAR(255) NOT NULL,
  address_2           VARCHAR(255),
  city                VARCHAR(255) NOT NULL,
  province            VARCHAR(255),              -- state
  postal_code         VARCHAR(20) NOT NULL,       -- PIN code
  country_code        VARCHAR(2) DEFAULT 'in',
  phone               VARCHAR(20),
  metadata            JSONB,
  created_at          TIMESTAMPTZ DEFAULT NOW(),
  updated_at          TIMESTAMPTZ DEFAULT NOW()
)
```

### 2.6 Wishlist (Custom Extension)

```sql
-- Custom table outside MedusaJS core
wishlist_item (
  id                  UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  customer_id         VARCHAR(255) NOT NULL REFERENCES customer(id) ON DELETE CASCADE,
  product_id          VARCHAR(255) NOT NULL REFERENCES product(id) ON DELETE CASCADE,
  variant_id          VARCHAR(255) REFERENCES product_variant(id) ON DELETE SET NULL,
  created_at          TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(customer_id, product_id)
)
```

---

## 3. Key Indexes

```sql
-- Product lookups (most frequent queries)
CREATE INDEX idx_product_handle ON product(handle) WHERE deleted_at IS NULL;
CREATE INDEX idx_product_status ON product(status) WHERE deleted_at IS NULL;
CREATE INDEX idx_product_collection ON product(collection_id) WHERE deleted_at IS NULL;
CREATE INDEX idx_product_room_type ON product(room_type) WHERE deleted_at IS NULL;

-- Variant lookups
CREATE INDEX idx_variant_product ON product_variant(product_id) WHERE deleted_at IS NULL;
CREATE INDEX idx_variant_sku ON product_variant(sku) WHERE deleted_at IS NULL;

-- Cart lookups
CREATE INDEX idx_cart_customer ON cart(customer_id) WHERE deleted_at IS NULL;
CREATE INDEX idx_line_item_cart ON line_item(cart_id);
CREATE INDEX idx_line_item_order ON line_item(order_id);

-- Order lookups
CREATE INDEX idx_order_customer ON "order"(customer_id);
CREATE INDEX idx_order_display_id ON "order"(display_id);
CREATE INDEX idx_order_payment_status ON "order"(payment_status);

-- Customer lookups
CREATE INDEX idx_customer_email ON customer(email) WHERE deleted_at IS NULL;

-- Wishlist lookups
CREATE INDEX idx_wishlist_customer ON wishlist_item(customer_id);
```

---

## 4. Data Integrity Rules

- Monetary values are always integers (paise). Never use DECIMAL for prices in application code.
- Line items store a **snapshot** of price and title at time of cart add — changes to product prices do not retroactively change existing cart items or orders.
- `deleted_at` is used for soft deletes on products, variants, customers, and carts. Always filter with `WHERE deleted_at IS NULL` in queries.
- Orders are append-only once created. Status changes are tracked; rows are never deleted.
- Fulfilment tracking numbers are stored as `TEXT[]` (array) to support multiple tracking numbers per order.

---

*Owner: Engineering Lead | Shree Furniture | v1.0 — Q1 2026*
